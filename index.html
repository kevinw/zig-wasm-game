<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Zig-WebGL-WASM</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="page">
    <div class="container">
      <div class="col">
        <div class="wrapper">
          <canvas id="canvasgl" width="400" height="400" style="width: 800px; height: 800px;"></canvas>
            <input id="equation-input" type="text" value="" />
        </div>
        WASD to move, IJKL to shoot
      </div>
    </div>
  </div>
  <script>
    var $webgl = document.getElementById("canvasgl");
  </script>
  <script src="js/dom.js"></script>
  <script src="js/audio.js"></script>
  <script src="js/webgl.js"></script>
  <script src="js/wasm.js"></script>
  <script src="js/loader.js"></script>
  <script>
    function startGame() {
        const env = {
          ...wasm,
          ...audio,
          ...zigdom,
          ...webgl,
        }

        fetchAndInstantiate('main_web.wasm', { env }).then(instance => {
          memory = instance.exports.memory;
          exports = instance.exports;

          exports.onInit($webgl.width, $webgl.height);

          document.addEventListener('keydown', e => exports.onKeyDown(e.keyCode, 1, e.repeat));
          document.addEventListener('keyup', e => exports.onKeyUp(e.keyCode, 0));
          document.addEventListener('mousedown', e => exports.onMouseDown(e.button, e.x, e.y));
          document.addEventListener('mouseup', e => exports.onMouseUp(e.button, e.x, e.y));
          document.addEventListener('mousemove', e => exports.onMouseMove(e.x, e.y));
          document.addEventListener('resize', e => exports.onResize(e.width, e.height));

            const sendEq = () => {
              var res = copyBytesToWASM(eqInp.value);
              if (!res.success) {
                  console.error("error copying bytes to wasm");
                  return;
              }

              instance.exports.onEquation(res.ptr, res.len);
            };

          const eqInp = document.getElementById("equation-input");
          eqInp.addEventListener("keyup", function(e) {
              if (event.key === "Enter")
                  sendEq();
          });

          const onAnimationFrame = instance.exports.onAnimationFrame;
          function step(timestamp) {
            onAnimationFrame(timestamp);
            window.requestAnimationFrame(step);
          }

          window.requestAnimationFrame(step);

            const startEquation = 
                //"10  + 165 * sin(2.5+ (y-50) / 26 ) + 90*sin( time*0.7 - ((0.1*( x - 50 )^2 + (y-50)^2 )^0.45) ) - 255 * (1 + (((x-1) % 50) - (x % 50))) * (1 + (( (y+30-(time%18)-1) % 10) - ( (y+30-(time%18)) % 10))) * ((y%50) + (50-y)%50)"
                //"((time-x+y)|(time-y+x)|(time+x+y)|(time-x-y))^6" // TODO: why is this one so different? https://maxbittker.github.io/Mojulo/#KCh0aW1lLXgreSl8KHRpbWUteSt4KXwodGltZSt4K3kpfCh0aW1lLXgteSkpXjY=


                //(y*x-(time*1))&(y+(cos(r*0.01*time)))
                //r*A*r*pow(sin(0.001*time)+(cos(0.01*time)+1),A)

                "(((((sin(A * 20 + time/14) + 2) * 30 + (cos(r * (20 + sin(A * 2 + time/41) * 5) + time/22) + 4) * 30) + (sin(x * time / y / 1000) + 2) * 5 - 20)*0x0000ff)&0x00ff00) + (((((sin(A * 20 + time/7) + 2) * 30 + (cos(r * (20 + sin(A * 2 + time/83) * 5) + time/11) + 4) * 30) + (sin(x * time / y / 1000) + 2) * 5 - 20)*1)&0x0000ff) + (((((sin(A * 20 + time/3.5) + 2) * 30 + (cos(r * (20 + sin(A * 2 + time/166) * 5) + time/6) + 4) * 30) + (sin(x * time / y / 1000) + 2) * 5 - 20)*0x00ff00)&0xff0000)"
            ;

            eqInp.value = startEquation;
            sendEq();

        });
    }


    startGame();
  </script>
</body>

</html>
